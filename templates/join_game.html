{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/join_game.css') }}">
{% endblock %}

{% block body %}
<div class="container">
    <h1>Verf√ºgbare Spiele</h1>
    
    <div class="direct-join">
        <h3>Direkt beitreten:</h3>
        <div class="join-form">
            <input type="text" id="roomCode" placeholder="Raum-Code eingeben">
            <button class="btn btn-success" onclick="joinByCode()">Beitreten</button>
        </div>
    </div>

    <div class="room-list" id="roomList">
        <p>Lade verf√ºgbare R√§ume...</p>
    </div>
</div>

<!-- Name Eingabe Modal -->
<div class="modal-overlay" id="nameModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Spielernamen eingeben</h3>
            <button class="modal-close" onclick="closeNameModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-form-group">
                <label for="playerNameInput">Dein Name:</label>
                <input type="text" id="playerNameInput" placeholder="Gib deinen Namen ein" maxlength="20" autocomplete="off">
                <small class="modal-form-hint">Maximal 20 Zeichen</small>
            </div>
            <!-- Zugangscode Eingabe f√ºr private R√§ume -->
            <div class="modal-form-group" id="accessCodeGroup" style="display: none;">
                <label for="modalAccessCode">Zugangscode:</label>
                <input type="text" id="modalAccessCode" placeholder="Zugangscode f√ºr privaten Raum" autocomplete="off">
                <small class="modal-form-hint">Dieser Raum ist privat. Bitte gib den Zugangscode ein.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeNameModal()">Abbrechen</button>
            <button class="btn btn-success" onclick="submitPlayerName()">Beitreten</button>
        </div>
    </div>
</div>

<!-- Modal f√ºr Raum-Informationen -->
<div id="modalData" 
     data-room-id=""
     data-access-code=""
     data-room-type=""
     style="display: none;">
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentRoomData = {
        roomId: '',
        accessCode: '',
        roomType: ''
    };

    document.addEventListener('DOMContentLoaded', function() {
        const roomCodeInput = document.getElementById('roomCode');
        if (roomCodeInput) {
            roomCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinByCode();
                }
            });
        }
        
        // Enter-Taste im Namens-Input
        const playerNameInput = document.getElementById('playerNameInput');
        if (playerNameInput) {
            playerNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPlayerName();
                }
            });
        }
        
        // Enter-Taste im Zugangscode-Input
        const accessCodeInput = document.getElementById('modalAccessCode');
        if (accessCodeInput) {
            accessCodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPlayerName();
                }
            });
        }
        
        loadAvailableRooms();
        setInterval(loadAvailableRooms, 5000);
    });
    
    function loadAvailableRooms() {
        fetch('/api/rooms')
            .then(response => response.json())
            .then(rooms => {
                const roomList = document.getElementById('roomList');
                
                if (rooms.length === 0) {
                    roomList.innerHTML = '<p>Keine aktiven R√§ume verf√ºgbar</p>';
                    return;
                }
                
                roomList.innerHTML = '';
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item';
                    
                    // Status anzeigen
                    const statusText = room.status === 'ready' ? 'üü¢ Startbereit' : 'üî¥ Wartet auf Spieler';
                    
                    // Raumtyp anzeigen
                    const roomTypeBadge = room.room_type === 'private' ? 'üîí Privat' : 'üåê √ñffentlich';
                    
                    roomElement.innerHTML = `
                        <div class="room-info">
                            <strong>Raum ${room.id}</strong>
                            <p class="room-meta-primary">
                                ${room.player_count} Spieler | ${statusText} | ${roomTypeBadge}
                            </p>
                            <p class="room-meta-secondary">
                                Gruppengr√∂√üe: ${room.settings.group_size} | Multiplikator: ${room.settings.multiplier}√ó
                            </p>
                        </div>
                        <button class="join-btn" onclick="openNameModal('${room.id}', '${room.room_type}', '')">Beitreten</button>
                    `;
                    roomList.appendChild(roomElement);
                });
            })
            .catch(error => {
                console.error('Fehler beim Laden der R√§ume:', error);
                showNotification('Fehler beim Laden der R√§ume', 'error');
            });
    }

    function openNameModal(roomId, roomType = 'public', accessCode = '') {
        currentRoomData = {
            roomId: roomId,
            roomType: roomType,
            accessCode: accessCode
        };
        
        // Zeige/Verstecke das Zugangscode-Feld basierend auf dem Raumtyp
        const accessCodeGroup = document.getElementById('accessCodeGroup');
        if (accessCodeGroup) {
            if (roomType === 'private') {
                accessCodeGroup.style.display = 'block';
            } else {
                accessCodeGroup.style.display = 'none';
            }
        }
        
        // Modal anzeigen
        const modal = document.getElementById('nameModal');
        if (modal) {
            modal.style.display = 'flex';
            
            // Input fokussieren
            const nameInput = document.getElementById('playerNameInput');
            if (nameInput) {
                nameInput.value = '';
                nameInput.focus();
            }
            
            // Zugangscode-Feld leeren
            const accessCodeInput = document.getElementById('modalAccessCode');
            if (accessCodeInput) {
                accessCodeInput.value = '';
            }
        }
    }
    
    function closeNameModal() {
        const modal = document.getElementById('nameModal');
        if (modal) {
            modal.style.display = 'none';
        }
        currentRoomData = {
            roomId: '',
            accessCode: '',
            roomType: ''
        };
    }
    
    function submitPlayerName() {
        const playerNameInput = document.getElementById('playerNameInput');
        if (!playerNameInput) return;
        
        const playerName = playerNameInput.value.trim();
        
        if (!playerName) {
            showNotification('Bitte gib einen Namen ein', 'error');
            playerNameInput.focus();
            return;
        }
        
        if (playerName.length > 20) {
            showNotification('Name darf maximal 20 Zeichen lang sein', 'error');
            playerNameInput.focus();
            return;
        }
        
        // Lies den Zugangscode aus, wenn der Raum privat ist
        let accessCode = '';
        if (currentRoomData.roomType === 'private') {
            const accessCodeInput = document.getElementById('modalAccessCode');
            if (accessCodeInput) {
                accessCode = accessCodeInput.value.trim();
                if (!accessCode) {
                    showNotification('Bitte gib den Zugangscode f√ºr den privaten Raum ein', 'error');
                    accessCodeInput.focus();
                    return;
                }
            }
        }
        
        console.log('DEBUG: Sende join_room Event f√ºr Raum', currentRoomData.roomId);
        
        // Dem Raum per WebSocket beitreten
        socket.emit('join_room', {
            room_id: currentRoomData.roomId,
            player_name: playerName,
            access_code: accessCode
        });
        
        // Modal schlie√üen
        closeNameModal();
        
        // Ladeanimation anzeigen
        showNotification('Trete Raum bei...', 'info');
    }
    
    function joinByCode() {
        const roomCode = document.getElementById('roomCode').value.trim();
        
        if (!roomCode) {
            showNotification('Bitte gib einen Raum-Code ein', 'error');
            return;
        }
        
        // Pr√ºfe den Raumtyp, um zu wissen, ob ein Zugangscode ben√∂tigt wird
        fetch(`/api/room/${roomCode}/check_access`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    // √ñffne das Modal mit dem Raumtyp
                    openNameModal(roomCode, data.room_type, '');
                } else {
                    showNotification('Raum nicht gefunden', 'error');
                }
            })
            .catch(error => {
                console.error('Fehler beim Pr√ºfen des Raumtyps:', error);
                showNotification('Fehler beim Pr√ºfen des Raumtyps', 'error');
            });
    }
    
    // WebSocket Events f√ºr join_game.html
    socket.on('room_joined', function(data) {
        console.log('DEBUG: room_joined Event empfangen:', data);
        showNotification('Erfolgreich dem Raum beigetreten!', 'success');
        
        // Weiterleitung mit player_id als URL-Parameter
        window.location.href = `/game_room/${data.room_id}?player_id=${data.player_id}`;
    });
    
    socket.on('error', function(data) {
        console.error('DEBUG: WebSocket Error:', data);
        showNotification(data.message, 'error');
    });
</script>
{% endblock %}