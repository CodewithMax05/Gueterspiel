{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/join_game.css') }}">
{% endblock %}

{% block body %}
<div class="container">
    <h1>Verfügbare Spiele</h1>
    
    <div class="room-list" id="roomList">
        <p>Lade verfügbare Räume...</p>
    </div>

    <div class="direct-join">
        <h3>Direkt beitreten:</h3>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <input type="text" id="roomCode" placeholder="Raum-Code eingeben" style="flex-grow: 1;">
            <button class="btn" onclick="joinByCode()">Beitreten</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableRooms();
        
        // Aktualisiere Raumliste alle 5 Sekunden
        setInterval(loadAvailableRooms, 5000);
    });
    
    function loadAvailableRooms() {
        fetch('/api/rooms')
            .then(response => response.json())
            .then(rooms => {
                const roomList = document.getElementById('roomList');
                
                if (rooms.length === 0) {
                    roomList.innerHTML = '<p>Keine aktiven Räume verfügbar</p>';
                    return;
                }
                
                roomList.innerHTML = '';
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item';
                    roomElement.innerHTML = `
                        <div class="room-info">
                            <strong>Raum ${room.id}</strong>
                            <p>Spieler: ${room.player_count} | Gruppengröße: ${room.settings.group_size}</p>
                            <p>Startguthaben: ${parseFloat(room.settings.initial_coins).toFixed(2)} Coins | Multiplikator: ${room.settings.multiplier}×</p>
                        </div>
                        <button class="join-btn" onclick="joinRoom('${room.id}')">Beitreten</button>
                    `;
                    roomList.appendChild(roomElement);
                });
            })
            .catch(error => {
                console.error('Fehler beim Laden der Räume:', error);
                showNotification('Fehler beim Laden der Räume', 'error');
            });
    }
    
    function joinRoom(roomId) {
        const playerName = prompt('Bitte gib deinen Namen ein:');
        
        if (!playerName || playerName.trim() === '') {
            showNotification('Bitte gib einen gültigen Namen ein', 'error');
            return;
        }
        
        if (playerName.length > 20) {
            showNotification('Name darf maximal 20 Zeichen lang sein', 'error');
            return;
        }
        
        console.log('DEBUG: Sende join_room Event für Raum', roomId);
        
        // Dem Raum per WebSocket beitreten
        socket.emit('join_room', {
            room_id: roomId,
            player_name: playerName.trim()
        });
    }
    
    function joinByCode() {
        const roomCode = document.getElementById('roomCode').value.trim();
        
        if (!roomCode) {
            showNotification('Bitte gib einen Raum-Code ein', 'error');
            return;
        }
        
        joinRoom(roomCode);
    }
    
    // WebSocket Events für join_game.html
    socket.on('room_joined', function(data) {
        console.log('DEBUG: room_joined Event empfangen:', data);
        showNotification('Erfolgreich dem Raum beigetreten!', 'success');
        
        // Weiterleitung mit player_id als URL-Parameter
        window.location.href = `/game_room/${data.room_id}?player_id=${data.player_id}`;
    });
    
    socket.on('error', function(data) {
        console.error('DEBUG: WebSocket Error:', data);
        showNotification(data.message, 'error');
    });
    
    // Debugging: WebSocket Verbindungsstatus
    socket.on('connect', function() {
        console.log('DEBUG: Mit Server verbunden');
    });
    
    socket.on('disconnect', function() {
        console.log('DEBUG: Vom Server getrennt');
    });
</script>
{% endblock %}