{% extends "base.html" %}

{% block head %}
<style>
    .room-list { margin: 20px 0; }
    .room-item { 
        padding: 15px; 
        border: 1px solid #34495e; 
        margin: 10px 0; 
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .room-info { flex-grow: 1; }
    .join-btn { 
        padding: 8px 16px; 
        background: #28a745; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
    }
    .direct-join { 
        margin-top: 30px; 
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <h1>Verfügbare Spiele</h1>
    
    <div class="room-list" id="roomList">
        <p>Lade verfügbare Räume...</p>
    </div>

    <div class="direct-join">
        <h3>Direkt beitreten:</h3>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <input type="text" id="roomCode" placeholder="Raum-Code eingeben" style="flex-grow: 1;">
            <button class="btn" onclick="joinByCode()">Beitreten</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadAvailableRooms();
        
        // Aktualisiere Raumliste alle 5 Sekunden
        setInterval(loadAvailableRooms, 5000);
    });
    
    function loadAvailableRooms() {
        fetch('/api/rooms')
            .then(response => response.json())
            .then(rooms => {
                const roomList = document.getElementById('roomList');
                
                if (rooms.length === 0) {
                    roomList.innerHTML = '<p>Keine aktiven Räume verfügbar</p>';
                    return;
                }
                
                roomList.innerHTML = '';
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item';
                    roomElement.innerHTML = `
                        <div class="room-info">
                            <strong>Raum ${room.id}</strong>
                            <p>Spieler: ${room.player_count} | Gruppengröße: ${room.settings.group_size}</p>
                            <p>Startguthaben: ${room.settings.initial_coins} Coins | Multiplikator: ${room.settings.multiplier}×</p>
                        </div>
                        <button class="join-btn" onclick="joinRoom('${room.id}')">Beitreten</button>
                    `;
                    roomList.appendChild(roomElement);
                });
            })
            .catch(error => {
                console.error('Fehler beim Laden der Räume:', error);
                showNotification('Fehler beim Laden der Räume', 'error');
            });
    }
    
    function joinRoom(roomId) {
        const playerName = prompt('Bitte gib deinen Namen ein:');
        
        if (!playerName || playerName.trim() === '') {
            showNotification('Bitte gib einen gültigen Namen ein', 'error');
            return;
        }
        
        if (playerName.length > 20) {
            showNotification('Name darf maximal 20 Zeichen lang sein', 'error');
            return;
        }
        
        console.log('DEBUG: Sende join_room Event für Raum', roomId);
        
        // Dem Raum per WebSocket beitreten
        socket.emit('join_room', {
            room_id: roomId,
            player_name: playerName.trim()
        });
    }
    
    function joinByCode() {
        const roomCode = document.getElementById('roomCode').value.trim();
        
        if (!roomCode) {
            showNotification('Bitte gib einen Raum-Code ein', 'error');
            return;
        }
        
        joinRoom(roomCode);
    }
    
    // WebSocket Events für join_game.html
    socket.on('room_joined', function(data) {
        console.log('DEBUG: room_joined Event empfangen für Raum', data.room_id);
        showNotification('Erfolgreich dem Raum beigetreten!', 'success');
        
        // Direkte Weiterleitung ohne Verzögerung
        window.location.href = `/game_room/${data.room_id}`;
    });
    
    socket.on('error', function(data) {
        console.error('DEBUG: WebSocket Error:', data);
        showNotification(data.message, 'error');
    });
    
    // Debugging: WebSocket Verbindungsstatus
    socket.on('connect', function() {
        console.log('DEBUG: Mit Server verbunden');
    });
    
    socket.on('disconnect', function() {
        console.log('DEBUG: Vom Server getrennt');
    });
</script>
{% endblock %}