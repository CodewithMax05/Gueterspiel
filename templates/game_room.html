{% extends "base.html" %}

{% block head %}
<style>
    .player-list { margin: 20px 0; }
    .player-item { 
        padding: 15px; 
        border: 1px solid #34495e; 
        margin: 10px 0; 
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
    }
    .player-item.ready { 
        background: rgba(40, 167, 69, 0.2); 
        border-color: #28a745;
    }
    .room-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .requirements {
        background: rgba(255, 193, 7, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #ffc107;
    }
</style>
{% endblock %}

{% block body %}
<!-- Daten f√ºr JavaScript -->
<div id="room-data" 
     data-room-id="{{ room.id }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     data-ready-count="{{ room.ready_players|length }}"
     data-total-players="{{ room.players|length }}"
     data-player-id="{{ player.id }}"
     data-player-ready="{{ 'true' if player.ready else 'false' }}"
     style="display: none;">
</div>

<div class="container">
    <h1>Spielraum: {{ room.id }}</h1>
    
    <div class="room-info">
        <p><strong>Raum-Code:</strong> {{ room.id }}</p>
        <p><strong>Status:</strong> {{ room.status }}</p>
        <p><strong>Spieler im Raum:</strong> {{ room.players|length }}</p>
        <p><strong>Bereite Spieler:</strong> <span id="readyCount">{{ room.ready_players|length }}</span></p>
    </div>

    {% if is_leader %}
    <div class="requirements">
        <h4>Voraussetzungen f√ºr Spielstart:</h4>
        <ul>
            <li id="reqMinPlayers">‚úì Mindestens 4 Spieler bereit</li>
            <li id="reqDivisible">‚úì Anzahl der Spieler muss durch 4 teilbar sein</li>
        </ul>
    </div>
    {% endif %}
    
    <div class="player-list">
        <h3>Spieler ({{ room.players|length }}):</h3>
        <div id="playersContainer">
            {% for player in room.players %}
            <div class="player-item {% if player.ready %}ready{% endif %}" id="player-{{ player.id }}">
                {{ player.name }} 
                {% if player.ready %}
                <span style="color: #28a745;">‚úÖ Bereit</span>
                {% else %}
                <span style="color: #dc3545;">‚ùå Nicht bereit</span>
                {% endif %}
                {% if player.id == room.leader %}
                <span style="color: #ffc107;">üëë (Leader)</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Button f√ºr ALLE Spieler, die noch nicht bereit sind -->
    {% if not player.ready %}
    <button class="btn" id="readyBtn">Bereit</button>
    {% endif %}
    
    {% if is_leader %}
    <button class="btn btn-success" id="startBtn" disabled>Spiel starten</button>
    <div id="startError" style="color: #dc3545; margin-top: 10px; display: none;"></div>
    {% endif %}
</div>

<script>
    // Daten f√ºr JavaScript
    const roomData = document.getElementById('room-data');
    const roomId = roomData.dataset.roomId;
    const isLeader = roomData.dataset.isLeader === 'true';
    const playerId = roomData.dataset.playerId;
    const playerReady = roomData.dataset.playerReady === 'true';
    let readyCount = parseInt(roomData.dataset.readyCount);
    const totalPlayers = parseInt(roomData.dataset.totalPlayers);

    console.log('Initialisierung:', { roomId, isLeader, playerId, playerReady, readyCount, totalPlayers });

    const socket = io();

    // Raum sofort betreten wenn Seite geladen ist
    socket.emit('join_room', { room_id: roomId });

    socket.on('connect', () => {
        console.log('Mit Server verbunden');
    });

    socket.on('player_joined', (data) => {
        console.log('Spieler beigetreten:', data);
        // Seite neu laden um aktuelle Spielerliste anzuzeigen
        if (data.player_id !== playerId) {
            setTimeout(() => location.reload(), 1000);
        }
    });

    socket.on('player_ready', (data) => {
        console.log('Spieler bereit:', data);
        
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            playerElement.classList.add('ready');
            const readySpan = playerElement.querySelector('span') || playerElement;
            if (readySpan.innerHTML.includes('Nicht bereit')) {
                readySpan.innerHTML = readySpan.innerHTML.replace('‚ùå Nicht bereit', '‚úÖ Bereit');
            }
        }
        
        // Aktualisiere Bereit-Z√§hler
        readyCount++;
        document.getElementById('readyCount').textContent = readyCount;
        
        // Aktualisiere Requirements f√ºr Leader
        if (isLeader) {
            updateStartButton();
        }
        
        // Wenn der aktuelle Spieler bereit ist, verstecke den Button
        if (data.player_id === playerId) {
            const readyBtn = document.getElementById('readyBtn');
            if (readyBtn) {
                readyBtn.style.display = 'none';
            }
        }
    });

    socket.on('start_button_update', (data) => {
        console.log('Start button update:', data);
        if (isLeader) {
            document.getElementById('startBtn').disabled = !data.can_start;
            updateRequirements(data.can_start);
        }
    });

    socket.on('start_failed', (data) => {
        console.log('Start fehlgeschlagen:', data);
        if (isLeader) {
            const errorDiv = document.getElementById('startError');
            errorDiv.style.display = 'block';
            errorDiv.textContent = data.message;
            // Nach 5 Sekunden ausblenden
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    });

    socket.on('game_started', () => {
        console.log('Spiel gestartet, weiterleiten...');
        window.location.href = '/game';
    });

    function updateStartButton() {
        const canStart = readyCount >= 4 && readyCount % 4 === 0 && totalPlayers % 4 === 0;
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.disabled = !canStart;
        }
        updateRequirements(canStart);
    }

    function updateRequirements(canStart) {
        const reqMinPlayers = document.getElementById('reqMinPlayers');
        const reqDivisible = document.getElementById('reqDivisible');
        
        if (!reqMinPlayers || !reqDivisible) return;
        
        if (canStart) {
            reqMinPlayers.style.color = '#28a745';
            reqDivisible.style.color = '#28a745';
            reqMinPlayers.innerHTML = '‚úì Mindestens 4 Spieler bereit';
            reqDivisible.innerHTML = '‚úì Anzahl der Spieler muss durch 4 teilbar sein';
        } else {
            reqMinPlayers.style.color = '#dc3545';
            reqDivisible.style.color = '#dc3545';
            reqMinPlayers.innerHTML = `‚úó Mindestens 4 Spieler bereit (aktuell: ${readyCount})`;
            reqDivisible.innerHTML = `‚úó Anzahl der Spieler muss durch 4 teilbar sein (aktuell: ${readyCount}/${totalPlayers})`;
        }
    }

    // Event Listener f√ºr Buttons
    document.addEventListener('DOMContentLoaded', function() {
        const readyBtn = document.getElementById('readyBtn');
        const startBtn = document.getElementById('startBtn');
        
        if (readyBtn && !playerReady) {
            readyBtn.addEventListener('click', function() {
                console.log('Sende set_ready event');
                socket.emit('set_ready', {});
                this.disabled = true;
                this.textContent = 'Wird gesendet...';
            });
        }
        
        if (startBtn && isLeader) {
            startBtn.addEventListener('click', function() {
                console.log('Sende start_game event');
                socket.emit('start_game');
                this.disabled = true;
                this.textContent = 'Starte Spiel...';
            });
        }
        
        // Initialisiere Requirements f√ºr Leader
        if (isLeader) {
            updateStartButton();
        }
        
        // Verstecke den Ready-Button wenn der Spieler bereits bereit ist
        if (playerReady && readyBtn) {
            readyBtn.style.display = 'none';
        }
    });
</script>
{% endblock %}