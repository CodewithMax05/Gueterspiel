{% extends "base.html" %}

{% block head %}
<style>
    .player-list { margin: 20px 0; }
    .player-item { 
        padding: 15px; 
        border: 1px solid #34495e; 
        margin: 10px 0; 
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .player-item.ready { 
        background: rgba(40, 167, 69, 0.2); 
        border-color: #28a745;
    }
    .room-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .requirements {
        background: rgba(255, 193, 7, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #ffc107;
    }
    .connection-status {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 999;
    }
    .connection-status.connected {
        background: rgba(40, 167, 69, 0.3);
        border: 1px solid #28a745;
    }
    .connection-status.disconnected {
        background: rgba(220, 53, 69, 0.3);
        border: 1px solid #dc3545;
    }
    .player-status {
        margin-left: 10px;
    }
    .leader-info {
        background: rgba(255, 193, 7, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #ffc107;
    }
    
    /* Neue Styles für den Ready-Button */
    .ready-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 24px;
        border: 2px solid #667eea;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        transition: all 0.3s ease;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .ready-toggle:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: translateY(-2px);
    }
    
    .ready-toggle.ready {
        background: rgba(40, 167, 69, 0.2);
        border-color: #28a745;
        color: #28a745;
    }
    
    .ready-toggle.ready:hover {
        background: rgba(40, 167, 69, 0.3);
    }
    
    .checkbox-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
    }
    
    .checkbox-icon .fa-check-square {
        display: none;
        color: #28a745;
    }
    
    .checkbox-icon .fa-square {
        color: #667eea;
    }
    
    .ready-toggle.ready .fa-check-square {
        display: block;
    }
    
    .ready-toggle.ready .fa-square {
        display: none;
    }
    
    /* Loading state */
    .ready-toggle.loading {
        opacity: 0.7;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <h1>Spielraum: {{ room.id }}</h1>
    
    <!-- Einheitlicher Raum-Informationen Block -->
    <div class="room-info">
        <p><strong>Raum-Code:</strong> {{ room.id }}</p>
        <p><strong>Status:</strong> <span id="roomStatus">{{ room.status }}</span></p>
        <p><strong>Aktive Spieler:</strong> <span id="totalPlayers">{{ players|length }}</span></p>
        <p><strong>Bereite Spieler:</strong> <span id="readyCount">{{ ready_count }}</span></p>
        <p><strong>Gruppengröße:</strong> <span id="groupSize">{{ room.settings.get('group_size', 4) }}</span> Spieler</p>
        <p><strong>Erstellt von:</strong> {{ room.leader_name }}</p>
    </div>

    {% if is_leader %}
    <div class="requirements">
        <h4>Voraussetzungen für Spielstart:</h4>
        <ul>
            <li id="reqMinPlayers">Prüfe...</li>
        </ul>
    </div>
    {% endif %}
    
    <div class="player-list">
        <h3>Aktive Spieler:</h3>
        <div id="playersContainer">
            {% for p in players %}
            <div class="player-item {% if p.ready %}ready{% endif %}" id="player-{{ p.id }}">
                <div>
                    <span class="player-name">{{ p.name }}</span>
                    <span style="color: #666; margin-left: 10px;">({{ p.coins }} Coins)</span>
                </div>
                <span class="player-status">
                    {% if p.ready %}
                    <span style="color: #28a745;">✅ Bereit</span>
                    {% else %}
                    <span style="color: #dc3545;">❌ Nicht bereit</span>
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% if is_leader %}
    <button class="btn btn-success" id="startBtn" disabled>Spiel starten</button>
    <div id="startError" style="color: #dc3545; margin-top: 10px; display: none;"></div>
    {% endif %}

    {% if not is_leader %}
    <div style="text-align: center; margin: 20px 0;">
        <button class="ready-toggle {% for p in players %}{% if p.id == session.player_id %}{% if p.ready %}ready{% endif %}{% endif %}{% endfor %}" id="readyBtn">
            <span class="checkbox-icon">
                <i class="far fa-square"></i>
                <i class="fas fa-check-square"></i>
            </span>
            <span class="ready-text">
                {% for p in players %}
                    {% if p.id == session.player_id %}
                        {% if p.ready %}
                            Bereit
                        {% else %}
                            Bereit machen
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </span>
        </button>
    </div>
    {% endif %}
</div>

<div id="room-data" 
     data-room-id="{{ room.id }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     style="display: none;">
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const roomData = document.getElementById('room-data');
        const roomId = roomData.dataset.roomId;
        const isLeader = roomData.dataset.isLeader === 'true';
        
        // Prüfe Startbedingungen (nur für Leader)
        if (isLeader) {
            checkStartRequirements(roomId);
            setInterval(() => checkStartRequirements(roomId), 2000);
        }
        
        // Bereit-Button Event mit Debugging
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn) {
            readyBtn.addEventListener('click', function() {
                console.log('DEBUG: Ready-Button geklickt');
                console.log('DEBUG: Socket connected:', socket.connected);
                console.log('DEBUG: Session player_id:', currentPlayerId);
                
                // Button in Ladezustand versetzen
                const readyText = this.querySelector('.ready-text');
                readyText.textContent = '⏳ Wird verarbeitet...';
                this.classList.add('loading');
                this.disabled = true;
                
                socket.emit('player_ready');
            });
        }
        
        // Start-Button Event
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                console.log('DEBUG: Start-Button geklickt');
                socket.emit('start_game');
            });
        }
    });

    function checkStartRequirements(roomId) {
        fetch(`/api/room/${roomId}/requirements`)
            .then(response => response.json())
            .then(data => {
                const reqElement = document.getElementById('reqMinPlayers');
                const startBtn = document.getElementById('startBtn');
                const errorElement = document.getElementById('startError');
                
                if (!reqElement || !startBtn) return;
                
                if (data.can_start) {
                    reqElement.innerHTML = '✅ Alle Voraussetzungen erfüllt!';
                    startBtn.disabled = false;
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    reqElement.innerHTML = `❌ Benötigt: ${data.required_players} Spieler (aktuell: ${data.current_players})`;
                    startBtn.disabled = true;
                    if (errorElement) {
                        errorElement.textContent = data.message;
                        errorElement.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Fehler beim Prüfen der Startvoraussetzungen:', error);
            });
    }
    
    // WebSocket Events für game_room.html
    socket.on('player_joined', function(data) {
        updatePlayerList(data);
        updatePlayerCount();
    });
    
    socket.on('player_left', function(data) {
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            playerElement.remove();
        }
        updatePlayerCount();
    });
    
    socket.on('player_ready_changed', function(data) {
        console.log('DEBUG: player_ready_changed Event empfangen:', data);
        
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            if (data.ready) {
                playerElement.classList.add('ready');
                const statusElement = playerElement.querySelector('.player-status');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #28a745;">✅ Bereit</span>';
                }
            } else {
                playerElement.classList.remove('ready');
                const statusElement = playerElement.querySelector('.player-status');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #dc3545;">❌ Nicht bereit</span>';
                }
            }
        }
        
        // Aktualisiere Ready-Count
        const readyCountElement = document.getElementById('readyCount');
        if (readyCountElement) {
            readyCountElement.textContent = data.ready_count;
        }
        
        // Aktualisiere Ready-Button Text für den aktuellen Spieler
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn && data.player_id === currentPlayerId) {
            if (data.ready) {
                readyBtn.classList.add('ready');
                readyBtn.querySelector('.ready-text').textContent = 'Bereit';
            } else {
                readyBtn.classList.remove('ready');
                readyBtn.querySelector('.ready-text').textContent = 'Bereit machen';
            }
            
            // Button wieder aktivieren
            readyBtn.classList.remove('loading');
            readyBtn.disabled = false;
        }
    });
    
    socket.on('game_started', function(data) {
        console.log('DEBUG: game_started Event empfangen, leite weiter zu game.html');
        showNotification('Spiel startet!', 'success');
        
        // Weiterleitung zur game.html mit der room_id aus dem Event
        window.location.href = `/game/${data.room_id}`;
    });
    
    function updatePlayerList(playerData) {
        const container = document.getElementById('playersContainer');
        if (!container) return;
        
        const existingPlayer = document.getElementById(`player-${playerData.id}`);
        if (existingPlayer) return;
        
        const playerElement = document.createElement('div');
        playerElement.className = `player-item ${playerData.ready ? 'ready' : ''}`;
        playerElement.id = `player-${playerData.id}`;
        playerElement.innerHTML = `
            <div>
                <span class="player-name">${playerData.name}</span>
                <span style="color: #666; margin-left: 10px;">(${playerData.coins} Coins)</span>
            </div>
            <span class="player-status">
                ${playerData.ready ? 
                    '<span style="color: #28a745;">✅ Bereit</span>' : 
                    '<span style="color: #dc3545;">❌ Nicht bereit</span>'
                }
            </span>
        `;
        container.appendChild(playerElement);
    }
    
    function updatePlayerCount() {
        const playerItems = document.querySelectorAll('.player-item');
        const totalPlayersElement = document.getElementById('totalPlayers');
        if (totalPlayersElement) {
            totalPlayersElement.textContent = playerItems.length;
        }
    }
</script>
{% endblock %}