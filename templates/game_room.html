{% extends "base.html" %}

{% block head %}
<style>
    .player-list { margin: 20px 0; }
    .player-item { 
        padding: 15px; 
        border: 1px solid #34495e; 
        margin: 10px 0; 
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .player-item.ready { 
        background: rgba(40, 167, 69, 0.2); 
        border-color: #28a745;
    }
    .room-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .requirements {
        background: rgba(255, 193, 7, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #ffc107;
    }
    .connection-status {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 999;
    }
    .connection-status.connected {
        background: rgba(40, 167, 69, 0.3);
        border: 1px solid #28a745;
    }
    .connection-status.disconnected {
        background: rgba(220, 53, 69, 0.3);
        border: 1px solid #dc3545;
    }
    .player-status {
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block body %}
<!-- Daten f√ºr JavaScript -->
<div id="room-data" 
     data-room-id="{{ room.id }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     data-player-id="{{ player.id }}"
     data-player-ready="{{ 'true' if player.ready else 'false' }}"
     style="display: none;">
</div>

<!-- Verbindungsstatus -->
<div id="connectionStatus" class="connection-status disconnected">
    üî¥ Verbinde...
</div>

<div class="container">
    <h1>Spielraum: {{ room.id }}</h1>
    
    <div class="room-info">
        <p><strong>Raum-Code:</strong> {{ room.id }}</p>
        <p><strong>Status:</strong> <span id="roomStatus">{{ room.status }}</span></p>
        <p><strong>Spieler im Raum:</strong> <span id="totalPlayers">{{ room.players|length }}</span></p>
        <p><strong>Bereite Spieler:</strong> <span id="readyCount">{{ room.ready_players|length }}</span></p>
    </div>

    {% if is_leader %}
    <div class="requirements">
        <h4>Voraussetzungen f√ºr Spielstart:</h4>
        <ul>
            <li id="reqMinPlayers">Pr√ºfe...</li>
            <li id="reqDivisible">Pr√ºfe...</li>
        </ul>
    </div>
    {% endif %}
    
    <div class="player-list">
        <h3>Spieler (<span id="playersCount">{{ room.players|length }}</span>):</h3>
        <div id="playersContainer">
            {% for p in room.players %}
            <div class="player-item {% if p.ready %}ready{% endif %}" id="player-{{ p.id }}">
                <div>
                    <span class="player-name">{{ p.name }}</span>
                </div>
                <span class="player-status">
                    {% if p.ready %}
                    <span style="color: #28a745;">‚úÖ Bereit</span>
                    {% else %}
                    <span style="color: #dc3545;">‚ùå Nicht bereit</span>
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Button f√ºr Spieler, die noch nicht bereit sind -->
    {% if not is_leader and not player.ready %}
    <button class="btn btn-primary" id="readyBtn" disabled>
        ‚è≥ Verbinde...
    </button>
    {% endif %}
    
    {% if is_leader %}
    <button class="btn btn-success" id="startBtn" disabled>Spiel starten</button>
    <div id="startError" style="color: #dc3545; margin-top: 10px; display: none;"></div>
    {% endif %}
</div>

<script>
    // Daten aus HTML lesen
    const roomData = document.getElementById('room-data');
    const roomId = roomData.dataset.roomId;
    const isLeader = roomData.dataset.isLeader === 'true';
    const playerId = roomData.dataset.playerId;
    let playerReady = roomData.dataset.playerReady === 'true';

    console.log('üéÆ Initialisierung:', { 
        roomId, 
        isLeader, 
        playerId, 
        playerReady
    });

    // Globalen Socket verwenden
    const socket = window.socket;
    let isConnected = socket.connected;

    // Verbindungsstatus UI
    function updateConnectionStatus(connected) {
        const statusDiv = document.getElementById('connectionStatus');
        if (connected) {
            statusDiv.textContent = 'üü¢ Verbunden';
            statusDiv.className = 'connection-status connected';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
        } else {
            statusDiv.textContent = 'üî¥ Verbinde...';
            statusDiv.className = 'connection-status disconnected';
            statusDiv.style.display = 'block';
        }
    }

    // Sofortigen Status setzen
    updateConnectionStatus(isConnected);

    // === SOCKET EVENTS ===
    socket.on('connect', () => {
        console.log('‚úÖ Socket verbunden:', socket.id);
        isConnected = true;
        updateConnectionStatus(true);

        // Dem Raum beitreten
        console.log('üì° Sende join_room f√ºr:', roomId);
        socket.emit('join_room', { room_id: roomId });

        // Ready Button aktivieren
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn && !playerReady) {
            readyBtn.disabled = false;
            readyBtn.textContent = '‚úã Bereit';
        }
    });

    // Connection Success Event
    socket.on('connection_success', (data) => {
        console.log('‚úÖ Server best√§tigt Verbindung:', data);
        updateConnectionStatus(true);
    });

    socket.on('room_joined', (data) => {
        console.log('üì• Raum beigetreten:', data);
        createFlashMessage('Mit Raum verbunden', 'success');
    });

    socket.on('reconnect_attempt', (attempt) => {
        console.log(`üîÑ Wiederherstellungsversuch: ${attempt}`);
        updateConnectionStatus(false);
    });

    socket.on('reconnect', (attempt) => {
        console.log('‚úÖ Verbindung wiederhergestellt');
        updateConnectionStatus(true);
        
        // Erneut dem Raum beitreten nach Reconnect
        socket.emit('join_room', { room_id: roomId });
    });

    socket.on('connect_error', (error) => {
        console.error('‚ùå Verbindungsfehler:', error);
        updateConnectionStatus(false);
        createFlashMessage('Verbindungsfehler: ' + error.message, 'error');
        
        // Ready Button deaktivieren
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn) {
            readyBtn.disabled = true;
            readyBtn.textContent = '‚ùå Verbindungsfehler';
        }
    });

    socket.on('disconnect', () => {
        console.log('‚ùå Socket getrennt');
        isConnected = false;
        updateConnectionStatus(false);

        // Ready Button deaktivieren
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn) {
            readyBtn.disabled = true;
            readyBtn.textContent = '‚è≥ Verbinde...';
        }
    });

    socket.on('room_update', (data) => {
        console.log('üîÑ Raum-Update:', data);
        updatePlayerList(data.players);
        updateReadyCount(data.ready_count);
        // wenn leader: Update Requirements basierend auf group_size
        if (isLeader) {
            updateStartButton(data.ready_count, data.total_players, data.group_size);
            updateRequirements(false, data.ready_count, data.total_players, data.group_size);
        }
    });

    socket.on('player_ready', (data) => {
        console.log('‚úÖ Spieler bereit:', data);
        updatePlayerStatus(data.player_id, true);
        updateReadyCount(data.ready_count);

        if (data.player_id === playerId) {
            createFlashMessage('Du bist jetzt bereit!', 'success');
            const readyBtn = document.getElementById('readyBtn');
            if (readyBtn) readyBtn.style.display = 'none';
            playerReady = true;
        } else {
            createFlashMessage(`${data.player_name} ist bereit!`, 'info');
        }

        if (isLeader) {
            updateStartButton(data.ready_count, data.total_players, data.group_size || 4);
        }
    });

    socket.on('start_button_update', (data) => {
        console.log('üéÆ Start-Button Update:', data);
        if (isLeader) {
            updateStartButton(data.ready_count, data.total_players, data.group_size);
            updateRequirements(data.can_start, data.ready_count, data.total_players, data.group_size);
        }
    });

    socket.on('start_failed', (data) => {
        console.error('‚ùå Start fehlgeschlagen:', data);
        createFlashMessage('Spielstart fehlgeschlagen: ' + data.message, 'error');
        
        // Button zur√ºcksetzen
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = 'Spiel starten';
        }
    });

    socket.on('error', (data) => {
        console.error('‚ùå Fehler:', data);
        createFlashMessage('Fehler: ' + data.message, 'error');
    });

    // === HELPER FUNKTIONEN ===
    function updatePlayerList(players) {
        const container = document.getElementById('playersContainer');
        const countElement = document.getElementById('playersCount');
        if (countElement) countElement.textContent = players.length;

        // Vollst√§ndiges Rendering
        container.innerHTML = '';
        players.forEach(p => {
            const div = document.createElement('div');
            div.className = 'player-item' + (p.ready ? ' ready' : '');
            div.id = `player-${p.id}`;
            div.innerHTML = `
                <div>
                    <span class="player-name">${p.name}</span>
                </div>
                <span class="player-status">
                    ${p.ready ? '<span style="color: #28a745;">‚úÖ Bereit</span>' : '<span style="color: #dc3545;">‚ùå Nicht bereit</span>'}
                </span>
            `;
            container.appendChild(div);
        });
        
        // Leader separat anzeigen (nicht in der Spielerliste)
        const roomData = document.getElementById('room-data');
        const isLeader = roomData.dataset.isLeader === 'true';
        if (isLeader) {
            const leaderDiv = document.createElement('div');
            leaderDiv.className = 'player-item ready';
            leaderDiv.innerHTML = `
                <div>
                    <span class="player-name">${roomData.dataset.playerName || 'Leader'}</span>
                    <span style="color: #ffc107; margin-left: 10px;">üëë (Leader)</span>
                </div>
                <span class="player-status">
                    <span style="color: #28a745;">‚úÖ Immer bereit</span>
                </span>
            `;
            container.insertBefore(leaderDiv, container.firstChild);
        }
    }

    function updatePlayerStatus(playerId, isReady) {
        const playerElement = document.getElementById(`player-${playerId}`);
        if (playerElement) {
            if (isReady) {
                playerElement.classList.add('ready');
                const statusSpan = playerElement.querySelector('.player-status');
                if (statusSpan) statusSpan.innerHTML = '<span style="color: #28a745;">‚úÖ Bereit</span>';
            }
        }
    }

    function updateReadyCount(count) {
        const readyCountElement = document.getElementById('readyCount');
        if (readyCountElement) readyCountElement.textContent = count;
    }

    function updateStartButton(readyCount, totalPlayers, groupSize = 4) {
        const canStart = readyCount >= groupSize && readyCount % groupSize === 0 && totalPlayers % groupSize === 0;
        const startBtn = document.getElementById('startBtn');
        if (startBtn) startBtn.disabled = !canStart;
    }

    function updateRequirements(canStart, ready, total, groupSize = 4) {
        const reqMinPlayers = document.getElementById('reqMinPlayers');
        const reqDivisible = document.getElementById('reqDivisible');
        if (!reqMinPlayers || !reqDivisible) return;

        const minMet = ready >= groupSize;
        const divisibleMet = ready % groupSize === 0 && total % groupSize === 0;

        reqMinPlayers.style.color = minMet ? '#28a745' : '#dc3545';
        reqMinPlayers.innerHTML = minMet 
            ? `‚úì Mindestens ${groupSize} Spieler bereit` 
            : `‚úó Mindestens ${groupSize} Spieler bereit (aktuell: ${ready})`;

        reqDivisible.style.color = divisibleMet ? '#28a745' : '#dc3545';
        reqDivisible.innerHTML = divisibleMet 
            ? `‚úì Anzahl durch ${groupSize} teilbar` 
            : `‚úó Anzahl durch ${groupSize} teilbar (aktuell: ${ready}/${total})`;
    }

    // === EVENT HANDLERS ===
    document.addEventListener('DOMContentLoaded', function() {
        // Sofort dem Raum beitreten (wenn schon verbunden)
        if (isConnected) {
            console.log('üöÄ Sofortiger Raum-Beitritt:', roomId);
            socket.emit('join_room', { room_id: roomId });
        } else {
            // Raum f√ºr sp√§ter speichern
            window.joinRoomGlobal(roomId);
        }

        const readyBtn = document.getElementById('readyBtn');
        const startBtn = document.getElementById('startBtn');

        // Leader sieht keinen Ready-Button
        if (isLeader) {
            if (readyBtn) readyBtn.style.display = 'none';
            playerReady = true;
        } else if (readyBtn && !playerReady) {
            readyBtn.addEventListener('click', function() {
                if (!isConnected) {
                    createFlashMessage('Keine Verbindung zum Server', 'error');
                    return;
                }
                
                this.disabled = true;
                this.textContent = '‚è≥ Sende...';
                
                console.log('üì§ Sende set_ready f√ºr:', playerId);
                socket.emit('set_ready', { 
                    room_id: roomId 
                });
            });
        }

        if (startBtn && isLeader) {
            startBtn.addEventListener('click', function() {
                if (!isConnected) {
                    createFlashMessage('Keine Verbindung zum Server', 'error');
                    return;
                }
                this.disabled = true;
                this.textContent = 'üöÄ Starte...';
                socket.emit('start_game', { room_id: roomId, player_id: playerId });
            });
        }

        // Update der Startbedingungen f√ºr Leader
        if (isLeader) {
            const readyCount = parseInt(document.getElementById('readyCount').textContent);
            const totalPlayers = parseInt(document.getElementById('totalPlayers').textContent);
            updateStartButton(readyCount, totalPlayers, parseInt(roomData.dataset.groupSize || 4));
            updateRequirements(false, readyCount, totalPlayers, parseInt(roomData.dataset.groupSize || 4));
        }
    });
</script>
{% endblock %}