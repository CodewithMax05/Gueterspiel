{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game_room.css') }}">
{% endblock %}

{% block body %}
<div class="container">
    <h1>Spielraum: {{ room.id }}</h1>

    <!-- Raumleiter Anzeige -->
    <div class="leader-item">
        <div class="leader-avatar">
            <i class="fas fa-crown"></i>
        </div>
        <div class="leader-info">
            <span class="leader-name">{{ room.leader_name }}</span>
            <span class="leader-stats">
                <span class="role">Spielleiter / Moderator</span>
            </span>
        </div>
    </div>
    
    <!-- Einheitlicher Raum-Informationen Block -->
    <div class="room-info">
        <p><strong>Status:</strong> 
            <span id="roomStatus" class="status-{{ room.status }}">
                {% if room.status == 'waiting' %}üî¥ Wartet auf Spieler
                {% elif room.status == 'ready' %}üü¢ Startbereit
                {% else %}{{ room.status }}{% endif %}
            </span>
        </p>
        <p><strong>Raumtyp:</strong> 
            {% if room.room_type == 'public' %}
                üåê √ñffentlich
            {% else %}
                üîí Privat
            {% endif %}
        </p>
        {% if room.room_type == 'private' %}
        <p><strong>Zugangscode: </strong>{{ room.access_code }}</p>
        {% endif %}
        <p><strong>Spieler:</strong> <span id="totalPlayers">{{ players|length }}</span></p>
        <p><strong>Bereit:</strong> <span id="readyCount">{{ ready_count }}</span></p>
        <p><strong>Gruppengr√∂√üe:</strong> <span id="groupSize">{{ room.settings.get('group_size', 4) }}</span> Spieler</p>
        <p><strong>Erstellt von:</strong> {{ room.leader_name }}</p>
    </div>

    <!-- Buttons √ºber den Spielern -->
    <div class="action-buttons">
        {% if is_leader %}
        <div class="leader-actions">
            <div class="requirements">
                <h4>Voraussetzungen f√ºr Spielstart:</h4>
                <div id="reqMinPlayers">Pr√ºfe...</div>
            </div>
            <button class="btn btn-success" id="startBtn" disabled>Spiel starten</button>
        </div>
        {% else %}
        <div class="player-actions">
            <button class="ready-toggle {% for p in players %}{% if p.id == session.player_id %}{% if p.ready %}ready{% endif %}{% endif %}{% endfor %}" id="readyBtn">
                <span class="checkbox-icon">
                    <i class="far fa-square"></i>
                    <i class="fas fa-check-square"></i>
                </span>
                <span class="ready-text">
                    {% for p in players %}
                        {% if p.id == session.player_id %}
                            {% if p.ready %}
                                Bereit
                            {% else %}
                                Bereit machen
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </span>
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- Spielerliste -->
    <div class="player-list">
        <h3>Aktive Spieler:</h3>
        {% if room.incognito_mode and not is_leader %}
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; margin: 10px 0;">
            <p>üîí Inkognito-Modus aktiv</p>
            <p style="font-size: 14px; color: #aaa;">Namen anderer Spieler werden nicht angezeigt</p>
        </div>
        {% endif %}
        <div id="playersContainer">
            <!-- Eigenen Spieler ZUERST anzeigen -->
            {% for p in players %}
                {% if p.id == session.player_id %}
                <div class="player-item current-player {% if p.ready %}ready{% endif %}" id="player-{{ p.id }}">
                    <div>
                        <span class="player-name">‚≠ê {{ p.name }} (Du)</span>
                        <span style="color: #666; margin-left: 10px;">({{ "%.2f"|format(p.coins) }} Coins)</span>
                    </div>
                    <div class="player-actions">
                        <span class="player-status">
                            {% if p.ready %}
                            <span style="color: #28a745;">‚úÖ Bereit</span>
                            {% else %}
                            <span style="color: #dc3545;">‚ùå Nicht bereit</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            
            <!-- Dann andere Spieler anzeigen -->
            {% for p in players %}
                {% if p.id != session.player_id and (not room.incognito_mode or is_leader) %}
                <div class="player-item {% if p.ready %}ready{% endif %}" id="player-{{ p.id }}">
                    <div>
                        <span class="player-name">{{ p.name }}</span>
                        {% if not room.incognito_mode or is_leader %}
                        <span style="color: #666; margin-left: 10px;">({{ "%.2f"|format(p.coins) }} Coins)</span>
                        {% endif %}
                    </div>
                    <div class="player-actions">
                        <span class="player-status">
                            {% if p.ready %}
                            <span style="color: #28a745;">‚úÖ Bereit</span>
                            {% else %}
                            <span style="color: #dc3545;">‚ùå Nicht bereit</span>
                            {% endif %}
                        </span>
                        {% if is_leader %}
                        <button class="delete-player-btn" onclick="removePlayer('{{ p.id }}', '{{ p.name }}')" 
                                title="Spieler entfernen">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

<div id="room-data" 
     data-room-id="{{ room.id }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     data-room-leader-id="{{ room.leader_id }}"
     style="display: none;">
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const roomData = document.getElementById('room-data');
        const roomId = roomData.dataset.roomId;
        const isLeader = roomData.dataset.isLeader === 'true';
        const roomLeaderId = roomData.dataset.roomLeaderId;
        
        // Pr√ºfe Startbedingungen (nur f√ºr Leader)
        if (isLeader) {
            checkStartRequirements(roomId);
        }
        
        // Bereit-Button Event mit Debugging
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn) {
            readyBtn.addEventListener('click', function() {
                console.log('DEBUG: Ready-Button geklickt');
                console.log('DEBUG: Socket connected:', socket.connected);
                console.log('DEBUG: Session player_id:', currentPlayerId);
                
                // Button in Ladezustand versetzen
                const readyText = this.querySelector('.ready-text');
                readyText.textContent = '‚è≥ Wird verarbeitet...';
                this.classList.add('loading');
                this.disabled = true;
                
                socket.emit('player_ready');
            });
        }
        
        // Start-Button Event mit Flash-Message bei Fehler
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.addEventListener('click', function() {
                console.log('DEBUG: Start-Button geklickt');
                
                // Pr√ºfe erneut, ob Start m√∂glich ist
                fetch(`/api/room/${roomId}/requirements`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.can_start) {
                            socket.emit('start_game');
                        } else {
                            showNotification(data.message, 'error', 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Fehler beim Pr√ºfen der Startvoraussetzungen:', error);
                        showNotification('Fehler beim Starten des Spiels', 'error', 5000);
                    });
            });
        }
    });

    function updateRoomStatus(status) {
        const statusElement = document.getElementById('roomStatus');
        if (statusElement) {
            // Entferne alle Status-Klassen
            statusElement.className = 'status-' + status;
            
            // Text basierend auf Status setzen
            const statusTexts = {
                'waiting': 'üî¥ Wartet auf Spieler',
                'ready': 'üü¢ Startbereit'
            };
            
            // Falls ein unbekannter Status kommt, zeige den Statuscode an
            statusElement.textContent = statusTexts[status] || status;
        }
    }

    function checkRoomStatus() {
        // API-Aufruf um Status zu pr√ºfen
        fetch(`/api/room/${roomId}/status`)
            .then(response => response.json())
            .then(data => {
                updateRoomStatus(data.status);
            });
    }

    function removePlayer(playerId, playerName) {
        if (confirm(`M√∂chten Sie wirklich den Spieler "${playerName}" aus dem Raum entfernen?`)) {
            console.log('DEBUG: Entferne Spieler:', playerId);
            socket.emit('remove_player', { player_id: playerId });
        }
    }

    function checkStartRequirements(roomId) {
        fetch(`/api/room/${roomId}/requirements`)
            .then(response => response.json())
            .then(data => {
                const reqElement = document.getElementById('reqMinPlayers');
                const startBtn = document.getElementById('startBtn');
                
                if (!reqElement || !startBtn) return;
                
                if (data.can_start) {
                    reqElement.innerHTML = '‚úÖ Alle Voraussetzungen erf√ºllt!';
                    startBtn.disabled = false;
                } else {
                    reqElement.innerHTML = `‚ùå ${data.message}`;
                    startBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Fehler beim Pr√ºfen der Startvoraussetzungen:', error);
            });
    }

    function checkRequirementsOnEvents() {
        const roomData = document.getElementById('room-data');
        const roomId = roomData.dataset.roomId;
        const isLeader = roomData.dataset.isLeader === 'true';
        
        if (isLeader) {
            checkStartRequirements(roomId);
        }
    }
    
    // WebSocket Events f√ºr game_room.html
    socket.on('player_joined', function(data) {
        updatePlayerList(data);
        updatePlayerCount();
        checkRoomStatus();
        checkRequirementsOnEvents();
    });
    
    socket.on('player_left', function(data) {
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            playerElement.remove();
        }

        updatePlayerCount();
        checkRequirementsOnEvents();
    });
    
    socket.on('player_ready_changed', function(data) {
        console.log('DEBUG: player_ready_changed Event empfangen:', data);
        
        // Aktualisiere Spieler in der Liste
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            if (data.ready) {
                playerElement.classList.add('ready');
                const statusElement = playerElement.querySelector('.player-status');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #28a745;">‚úÖ Bereit</span>';
                }
            } else {
                playerElement.classList.remove('ready');
                const statusElement = playerElement.querySelector('.player-status');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #dc3545;">‚ùå Nicht bereit</span>';
                }
            }
        }
        
        // Aktualisiere Ready-Count
        const readyCountElement = document.getElementById('readyCount');
        if (readyCountElement) {
            readyCountElement.textContent = data.ready_count;
        }
        
        // Aktualisiere Ready-Button Text f√ºr den aktuellen Spieler
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn && data.player_id === currentPlayerId) {
            if (data.ready) {
                readyBtn.classList.add('ready');
                readyBtn.querySelector('.ready-text').textContent = 'Bereit';
            } else {
                readyBtn.classList.remove('ready');
                readyBtn.querySelector('.ready-text').textContent = 'Bereit machen';
            }
            
            // Button wieder aktivieren
            readyBtn.classList.remove('loading');
            readyBtn.disabled = false;
        }

        // Raumstatus aktualisieren
        updateRoomStatus(data.room_status);

        checkRequirementsOnEvents();
    });

    // WebSocket Event f√ºr entfernte Spieler
    socket.on('player_removed', function(data) {
        console.log('DEBUG: player_removed Event empfangen:', data);
        
        // Entferne Spieler aus der Liste
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            playerElement.remove();
        }
        
        // Aktualisiere Spieleranzahl
        updatePlayerCount();
        
        // Zeige Benachrichtigung
        if (data.removed_player_id === currentPlayerId) {
            // Dieser Spieler wurde entfernt
            showNotification('Sie wurden aus dem Raum entfernt.', 'error', 5000);
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
        } else {
            // Ein anderer Spieler wurde entfernt
            showNotification(`Spieler ${data.player_name} wurde entfernt.`, 'info', 3000);
        }
        
        checkRequirementsOnEvents();
    });

    socket.on('room_status_updated', function(data) {
        console.log('DEBUG: Raumstatus aktualisiert:', data);
        updateRoomStatus(data.status);
        
        // Ready-Count aktualisieren
        const readyCountElement = document.getElementById('readyCount');
        if (readyCountElement) {
            readyCountElement.textContent = data.ready_count;
        }
        
        checkRequirementsOnEvents();
    });
    
    socket.on('game_started', function(data) {
        console.log('DEBUG: game_started Event empfangen, leite weiter');
        showNotification('Spiel startet!', 'success');
        
        if (isLeader) {
            // Leader geht zum Dashboard
            window.location.href = `/leader_dashboard/${data.room_id}`;
        } else {
            // Spieler gehen zum Spiel
            window.location.href = `/game/${data.room_id}`;
        }
    });

    socket.on('error', function(data) {
        console.error('DEBUG: WebSocket Error:', data);
        showNotification(data.message, 'error', 5000);
    });
    
    function updatePlayerList(playerData) {
        const container = document.getElementById('playersContainer');
        if (!container) return;
        
        const existingPlayer = document.getElementById(`player-${playerData.id}`);
        if (existingPlayer) return;
        
        // Bestimme die CSS-Klassen basierend auf der Rolle des Spielers
        let playerClass = 'player-item';
        let playerName = playerData.name;
        let isCurrentPlayer = playerData.id === currentPlayerId;
        
        if (isCurrentPlayer) {
            playerClass += ' current-player';
            playerName = `‚≠ê ${playerData.name} (Du)`;
        }
        
        if (playerData.ready) {
            playerClass += ' ready';
        }
        
        const playerElement = document.createElement('div');
        playerElement.className = playerClass;
        playerElement.id = `player-${playerData.id}`;
        
        // Erstelle den HTML-Inhalt mit L√∂sch-Button f√ºr Leader (au√üer f√ºr sich selbst)
        let actionsHtml = '';
        
        // sichere, zuverl√§ssige Abfrage, ob dieser Client Leader ist
        const roomDataEl = document.getElementById('room-data');
        const leaderFlag = roomDataEl ? roomDataEl.dataset.isLeader === 'true' : (typeof isLeader !== 'undefined' && isLeader);

        // nur Leader (und nicht der aktuelle Spieler selbst) sehen den L√∂sch-Button
        if (leaderFlag && !isCurrentPlayer) {
            actionsHtml = `
                <button class="delete-player-btn" onclick="removePlayer('${playerData.id}', '${playerData.name}')" 
                        title="Spieler entfernen">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
        }
        
        playerElement.innerHTML = `
            <div>
                <span class="player-name">${playerName}</span>
                <span style="color: #666; margin-left: 10px;">(${playerData.coins} Coins)</span>
            </div>
            <div class="player-actions">
                <span class="player-status">
                    ${playerData.ready ? 
                        '<span style="color: #28a745;">‚úÖ Bereit</span>' : 
                        '<span style="color: #dc3545;">‚ùå Nicht bereit</span>'
                    }
                </span>
                ${actionsHtml}
            </div>
        `;
        
        // F√ºge den Spieler an der richtigen Position ein
        if (isCurrentPlayer) {
            // F√ºge den aktuellen Spieler immer an den ANFANG der Liste
            container.prepend(playerElement);
        } else {
            // F√ºge andere Spieler nach dem eigenen Spieler ein (aber vor anderen Spielern)
            const currentPlayerElement = document.querySelector('.player-item.current-player');
            if (currentPlayerElement && currentPlayerElement.nextSibling) {
                container.insertBefore(playerElement, currentPlayerElement.nextSibling);
            } else {
                container.appendChild(playerElement);
            }
        }
    }
    
    function updatePlayerCount() {
        const playerItems = document.querySelectorAll('.player-item');
        const totalPlayersElement = document.getElementById('totalPlayers');
        if (totalPlayersElement) {
            totalPlayersElement.textContent = playerItems.length;
        }
    }
</script>
{% endblock %}