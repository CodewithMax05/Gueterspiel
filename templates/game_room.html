{% extends "base.html" %}

{% block head %}
<style>
    .player-list { margin: 20px 0; }
    .player-item { 
        padding: 15px; 
        border: 1px solid #34495e; 
        margin: 10px 0; 
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
    }
    .player-item.ready { 
        background: rgba(40, 167, 69, 0.2); 
        border-color: #28a745;
    }
    .room-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }
    .requirements {
        background: rgba(255, 193, 7, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #ffc107;
    }
    .connection-status {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 999;
    }
    .connection-status.connected {
        background: rgba(40, 167, 69, 0.3);
        border: 1px solid #28a745;
    }
    .connection-status.disconnected {
        background: rgba(220, 53, 69, 0.3);
        border: 1px solid #dc3545;
    }
</style>
{% endblock %}

{% block body %}
<!-- Daten f√ºr JavaScript -->
<div id="room-data" 
     data-room-id="{{ room.id }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     data-ready-count="{{ room.ready_players|length }}"
     data-total-players="{{ room.players|length }}"
     data-group-size="{{ room.settings.group_size }}"
     data-player-id="{{ player.id }}"
     data-player-ready="{{ 'true' if player.ready else 'false' }}"
     style="display: none;">
</div>

<!-- Verbindungsstatus -->
<div id="connectionStatus" class="connection-status disconnected">
    üî¥ Verbinde...
</div>

<div class="container">
    <h1>Spielraum: {{ room.id }}</h1>
    
    <div class="room-info">
        <p><strong>Raum-Code:</strong> {{ room.id }}</p>
        <p><strong>Status:</strong> {{ room.status }}</p>
        <p><strong>Spieler im Raum:</strong> {{ room.players|length }}</p>
        <p><strong>Bereite Spieler:</strong> <span id="readyCount">{{ room.ready_players|length }}</span></p>
    </div>

    {% if is_leader %}
    <div class="requirements">
        <h4>Voraussetzungen f√ºr Spielstart:</h4>
        <ul>
            <li id="reqMinPlayers">Pr√ºfe...</li>
            <li id="reqDivisible">Pr√ºfe...</li>
        </ul>
    </div>
    {% endif %}
    
    <div class="player-list">
        <h3>Spieler ({{ room.players|length }}):</h3>
        <div id="playersContainer">
            {% for p in room.players %}
            <div class="player-item {% if p.ready %}ready{% endif %}" id="player-{{ p.id }}">
                <span class="player-name">{{ p.name }}</span>
                <span class="player-status">
                    {% if p.ready %}
                    <span style="color: #28a745;">‚úÖ Bereit</span>
                    {% else %}
                    <span style="color: #dc3545;">‚ùå Nicht bereit</span>
                    {% endif %}
                </span>
                {% if p.id == room.leader %}
                <span style="color: #ffc107;">üëë (Leader)</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Button f√ºr ALLE Spieler, die noch nicht bereit sind -->
    {% if not player.ready %}
    <button class="btn" id="readyBtn" disabled title="Warte auf Verbindung...">
        ‚è≥ Verbinde...
    </button>
    {% endif %}
    
    {% if is_leader %}
    <button class="btn btn-success" id="startBtn" disabled>Spiel starten</button>
    <div id="startError" style="color: #dc3545; margin-top: 10px; display: none;"></div>
    {% endif %}
</div>

<script>
    // Daten aus HTML lesen
    const roomData = document.getElementById('room-data');
    const roomId = roomData.dataset.roomId;
    const isLeader = roomData.dataset.isLeader === 'true';
    const playerId = roomData.dataset.playerId;
    const playerReady = roomData.dataset.playerReady === 'true';
    const groupSize = parseInt(roomData.dataset.groupSize) || 4;
    let readyCount = parseInt(roomData.dataset.readyCount);
    const totalPlayers = parseInt(roomData.dataset.totalPlayers);

    console.log('üéÆ Initialisierung:', { 
        roomId, 
        isLeader, 
        playerId, 
        playerReady, 
        readyCount, 
        totalPlayers,
        groupSize 
    });

    // Socket initialisieren
    const socket = io();
    let isConnected = false;
    let roomJoined = false;

    // Verbindungsstatus UI
    function updateConnectionStatus(connected) {
        const statusDiv = document.getElementById('connectionStatus');
        if (connected) {
            statusDiv.textContent = 'üü¢ Verbunden';
            statusDiv.className = 'connection-status connected';
            // Status nach 3 Sekunden ausblenden
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        } else {
            statusDiv.textContent = 'üî¥ Verbinde...';
            statusDiv.className = 'connection-status disconnected';
            statusDiv.style.display = 'block';
        }
    }

    // === SOCKET EVENTS ===
    
    socket.on('connect', () => {
        console.log('‚úÖ Socket verbunden:', socket.id);
        isConnected = true;
        updateConnectionStatus(true);
        
        // JETZT erst dem Raum beitreten
        console.log('üì° Sende join_room f√ºr:', roomId);
        socket.emit('join_room', { room_id: roomId });
        roomJoined = true;
        
        // Ready Button aktivieren wenn Spieler noch nicht bereit ist
        const readyBtn = document.getElementById('readyBtn');
        if (readyBtn && !playerReady) {
            readyBtn.disabled = false;
            readyBtn.textContent = '‚úã Bereit';
            readyBtn.title = 'Klicke um bereit zu sein';
        }
    });

    socket.on('disconnect', () => {
        console.log('‚ùå Socket getrennt');
        isConnected = false;
        roomJoined = false;
        updateConnectionStatus(false);
    });

    socket.on('error', (error) => {
        console.error('‚ùå Socket-Fehler:', error);
        createFlashMessage('Verbindungsfehler: ' + error.message, 'error');
    });

    socket.on('player_joined', (data) => {
        console.log('üë§ Spieler beigetreten:', data);
        if (data.player_id !== playerId) {
            createFlashMessage(`${data.player_name} ist beigetreten`, 'info');
            setTimeout(() => location.reload(), 1000);
        }
    });

    socket.on('player_ready', (data) => {
        console.log('‚úÖ Spieler bereit:', data);
        
        // Update Player in Liste
        const playerElement = document.getElementById(`player-${data.player_id}`);
        if (playerElement) {
            playerElement.classList.add('ready');
            const statusSpan = playerElement.querySelector('.player-status');
            if (statusSpan) {
                statusSpan.innerHTML = '<span style="color: #28a745;">‚úÖ Bereit</span>';
            }
        }
        
        // Update Counter
        readyCount++;
        document.getElementById('readyCount').textContent = readyCount;
        
        // Flash-Nachricht
        if (data.player_id === playerId) {
            createFlashMessage('Du bist jetzt bereit!', 'success');
        } else {
            createFlashMessage(`${data.player_name} ist bereit!`, 'info');
        }
        
        // Leader: Update Start-Button
        if (isLeader) {
            updateStartButton();
        }
        
        // Eigener Ready-Button verstecken
        if (data.player_id === playerId) {
            const readyBtn = document.getElementById('readyBtn');
            if (readyBtn) {
                readyBtn.style.display = 'none';
            }
        }
    });

    socket.on('start_button_update', (data) => {
        console.log('üéÆ Start-Button Update:', data);
        if (isLeader) {
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.disabled = !data.can_start;
            }
            updateRequirements(data.can_start, data.ready_count, data.total_players);
        }
    });

    socket.on('start_failed', (data) => {
        console.log('‚ùå Start fehlgeschlagen:', data);
        createFlashMessage(data.message, 'error');
        
        if (isLeader) {
            const errorDiv = document.getElementById('startError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = data.message;
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            // Start-Button wieder aktivieren
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.textContent = 'Spiel starten';
            }
        }
    });

    socket.on('game_started', () => {
        console.log('üöÄ Spiel gestartet!');
        createFlashMessage('Spiel startet jetzt!', 'success');
        setTimeout(() => {
            window.location.href = '/game';
        }, 500);
    });

    // === FUNKTIONEN ===

    function updateStartButton() {
        const canStart = readyCount >= groupSize && 
                        readyCount % groupSize === 0 && 
                        totalPlayers % groupSize === 0;
        
        const startBtn = document.getElementById('startBtn');
        if (startBtn) {
            startBtn.disabled = !canStart;
        }
        updateRequirements(canStart, readyCount, totalPlayers);
    }

    function updateRequirements(canStart, ready, total) {
        const reqMinPlayers = document.getElementById('reqMinPlayers');
        const reqDivisible = document.getElementById('reqDivisible');
        
        if (!reqMinPlayers || !reqDivisible) return;
        
        const minMet = ready >= groupSize;
        const divisibleMet = ready % groupSize === 0 && total % groupSize === 0;
        
        reqMinPlayers.style.color = minMet ? '#28a745' : '#dc3545';
        reqMinPlayers.innerHTML = minMet 
            ? `‚úì Mindestens ${groupSize} Spieler bereit` 
            : `‚úó Mindestens ${groupSize} Spieler bereit (aktuell: ${ready})`;
        
        reqDivisible.style.color = divisibleMet ? '#28a745' : '#dc3545';
        reqDivisible.innerHTML = divisibleMet 
            ? `‚úì Anzahl durch ${groupSize} teilbar` 
            : `‚úó Anzahl durch ${groupSize} teilbar (aktuell: ${ready}/${total})`;
    }

    // === EVENT HANDLERS ===

    document.addEventListener('DOMContentLoaded', function() {
        const readyBtn = document.getElementById('readyBtn');
        const startBtn = document.getElementById('startBtn');
        
        // Ready-Button Handler
        if (readyBtn && !playerReady) {
            readyBtn.addEventListener('click', function() {
                if (!isConnected) {
                    createFlashMessage('Keine Verbindung zum Server', 'error');
                    return;
                }
                
                if (!roomJoined) {
                    createFlashMessage('Raum noch nicht beigetreten', 'error');
                    return;
                }
                
                console.log('üì§ Sende set_ready Event');
                this.disabled = true;
                this.textContent = '‚è≥ Sende...';
                
                socket.emit('set_ready', {});
                
                // Timeout falls keine Antwort kommt
                setTimeout(() => {
                    if (this.disabled && this.textContent === '‚è≥ Sende...') {
                        console.error('‚ö†Ô∏è Keine Antwort auf set_ready erhalten');
                        this.disabled = false;
                        this.textContent = '‚úã Bereit';
                        createFlashMessage('Keine Antwort vom Server. Versuche es erneut.', 'error');
                    }
                }, 5000);
            });
        }
        
        // Start-Button Handler (nur Leader)
        if (startBtn && isLeader) {
            startBtn.addEventListener('click', function() {
                if (!isConnected) {
                    createFlashMessage('Keine Verbindung zum Server', 'error');
                    return;
                }
                
                console.log('üéÆ Sende start_game Event');
                this.disabled = true;
                this.textContent = 'üöÄ Starte...';
                
                socket.emit('start_game');
            });
        }
        
        // Initialisiere Requirements f√ºr Leader
        if (isLeader) {
            updateStartButton();
        }
        
        // Verstecke Ready-Button wenn bereits bereit
        if (playerReady && readyBtn) {
            readyBtn.style.display = 'none';
        }
    });
</script>
{% endblock %}