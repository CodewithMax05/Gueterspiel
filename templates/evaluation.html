{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/evaluation.css') }}">
{% endblock %}

{% block body %}
<div class="container">
    <h1>Spielauswertung</h1>
    
    <div class="summary">
        <h3>Dein Endergebnis:</h3>
        <p>Endguthaben: <strong>{{ "%.2f"|format(player.coins) }} Coins</strong></p>
        <p>Startguthaben: {{ "%.2f"|format(initial_coins) }} Coins</p>
        <p>Gewinn/Verlust: <strong>{{ "%.2f"|format(player.coins - initial_coins) }} Coins</strong></p>
    </div>
        
    <div class="balance-history">
        <h3>Guthabenverlauf:</h3>
        <ul class="history-list">
            {% for balance in player.game_history.balances %}
            <li>Runde {{ loop.index }}: {{ "%.2f"|format(balance) }} Coins</li>
            {% endfor %}
        </ul>
    </div>
    
    <div style="margin-top: 30px; text-align: center;">
        <a href="{{ url_for('index') }}" class="btn">Zurück zur Startseite</a>
        {% if is_leader %}
        <a href="#" class="btn btn-secondary">Detaillierte Auswertung (Leader)</a>
        {% endif %}
    </div>
</div>

<div id="evaluation-data" 
     data-initial-coins="{{ initial_coins }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     data-balances="{{ player.game_history.balances | tojson | safe }}"
     style="display: none;">
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const evaluationData = document.getElementById('evaluation-data');
        const balancesJson = evaluationData.dataset.balances;
        
        if (balancesJson) {
            try {
                const balances = JSON.parse(balancesJson);
                renderBalanceChart(balances);
            } catch (error) {
                console.error('Fehler beim Parsen der Balance-Daten:', error);
            }
        }
    });
    
    function renderBalanceChart(balances) {
        if (!balances || balances.length < 2) return;
        
        const container = document.querySelector('.balance-history');
        if (!container) return;
        
        // Einfaches Chart mit Canvas
        const canvas = document.createElement('canvas');
        canvas.width = 400;
        canvas.height = 200;
        canvas.className = 'balance-chart';
        
        container.appendChild(canvas);
        
        const context = canvas.getContext('2d');
        if (!context) return;
        
        // Zeichne einfachen Linienchart
        context.strokeStyle = '#667eea';
        context.lineWidth = 3;
        context.beginPath();
        
        const maxBalance = Math.max(...balances);
        const minBalance = Math.min(...balances);
        const range = maxBalance - minBalance || 1;
        
        const padding = 20;
        const chartWidth = canvas.width - 2 * padding;
        const chartHeight = canvas.height - 2 * padding;
        
        balances.forEach((balance, index) => {
            const x = padding + (index / (balances.length - 1)) * chartWidth;
            const y = canvas.height - padding - ((balance - minBalance) / range) * chartHeight;
            
            if (index === 0) {
                context.moveTo(x, y);
            } else {
                context.lineTo(x, y);
            }
            
            // Punkte zeichnen
            context.fillStyle = '#667eea';
            context.beginPath();
            context.arc(x, y, 4, 0, 2 * Math.PI);
            context.fill();
        });
        
        context.stroke();
        
        // Beschriftungen hinzufügen
        context.fillStyle = '#ffffff';
        context.font = '12px Arial';
        context.textAlign = 'center';
        
        // X-Achse Beschriftung (Runden)
        balances.forEach((balance, index) => {
            const x = padding + (index / (balances.length - 1)) * chartWidth;
            const y = canvas.height - 5;
            context.fillText(`R${index + 1}`, x, y);
        });
        
        // Y-Achse Beschriftung (Coins)
        context.textAlign = 'right';
        const steps = 5;
        for (let i = 0; i <= steps; i++) {
            const value = minBalance + (i / steps) * range;
            const y = canvas.height - padding - (i / steps) * chartHeight;
            context.fillText(value.toFixed(1), padding - 5, y + 3);
        }
    }
</script>
{% endblock %}