{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/evaluation.css') }}">
{% endblock %}

{% block body %}
<div class="evaluation-container">
    <h1 class="evaluation-title">Spielauswertung</h1>
    
    <!-- PersÃ¶nliche Zusammenfassung - Nur fÃ¼r Spieler, nicht fÃ¼r Leader -->
    {% if not is_leader %}
    <div class="summary-section">
        <h2>Dein persÃ¶nliches Ergebnis</h2>
        <div class="personal-stats">
            <div class="stat-card">
                <div class="stat-icon">ðŸ’°</div>
                <div class="stat-info">
                    <div class="stat-value">{{ "%.2f"|format(player.coins) }}</div>
                    <div class="stat-label">Endguthaben</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ“ˆ</div>
                <div class="stat-info">
                    <div class="stat-value {% if (player.coins - initial_coins) > 0 %}positive{% elif (player.coins - initial_coins) < 0 %}negative{% endif %}">
                        {{ "%+.2f"|format(player.coins - initial_coins) }}
                    </div>
                    <div class="stat-label">Gewinn/Verlust</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸŽ¯</div>
                <div class="stat-info">
                    <div class="stat-value">{{ player.game_history.contributions|sum if player.game_history.contributions else 0 | round(2) }}</div>
                    <div class="stat-label">Coins eingezahlt</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Detaillierte Gruppenstatistiken -->
    <div class="detailed-stats">        
        <!-- Diagramme nur fÃ¼r Spieler, nicht fÃ¼r Leader -->
        {% if not is_leader %}
        <h2>Detaillierte Statistiken</h2>

        <div class="stats-grid">
            <!-- Einzahlungsverlauf -->
            <div class="stat-chart">
                <h3>Einzahlungsverlauf deiner Gruppe</h3>
                <div class="chart-container">
                    <canvas id="contributionChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- Guthabenverlauf -->
            <div class="stat-chart">
                <h3>Guthabenverlauf</h3>
                <div class="chart-container">
                    <canvas id="balanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Vergleichstabelle mit Rang -->
        <div class="comparison-table">
            <h2>Gruppenvergleich</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Gruppe</th>
                            <th>Durchschn. Guthaben</th>
                            <th>Durchschn. Einzahlung</th>
                            <th>Gesamtgewinn</th>
                            <th>Kooperationsrate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group_data in group_comparison %}
                        <tr class="{% if player.id in group_data.group.player_ids %}highlight-row{% endif %}">
                            <td><strong>{{ loop.index }}</strong></td>
                            <td>
                                <strong>Gruppe {{ group_data.group.group_number }}</strong>
                            </td>
                            <td>{{ "%.2f"|format(group_data.avg_balance) }}</td>
                            <td>{{ "%.2f"|format(group_data.avg_contribution) }}</td>
                            <td class="{% if group_data.total_profit > 0 %}positive{% elif group_data.total_profit < 0 %}negative{% endif %}">
                                {{ "%+.2f"|format(group_data.total_profit) }}
                            </td>
                            <td>
                                <div class="cooperation-bar" data-rate="{{ group_data.avg_cooperation }}">
                                    <div class="cooperation-fill"></div>
                                    <span class="cooperation-text">{{ "%.1f"|format(group_data.avg_cooperation) }}%</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Aktionsbuttons -->
    <div class="action-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-large">ZurÃ¼ck zur Startseite</a>
        {% if is_leader %}
        <button class="btn btn-large btn-secondary" onclick="exportData()">Daten exportieren</button>
        {% endif %}
    </div>
</div>

<!-- Versteckte Daten fÃ¼r JavaScript -->
<div id="evaluation-data" 
     data-initial-coins="{{ initial_coins }}"
     data-is-leader="{{ 'true' if is_leader else 'false' }}"
     data-balances="{{ player.game_history.balances | tojson | safe }}"
     data-contributions="{{ player.game_history.contributions | tojson | safe }}"
     data-rounds="{{ room.current_round }}"
     style="display: none;">
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const evaluationData = document.getElementById('evaluation-data');
        const isLeader = evaluationData.dataset.isLeader === 'true';
        const balances = JSON.parse(evaluationData.dataset.balances || '[]');
        const contributions = JSON.parse(evaluationData.dataset.contributions || '[]');
        const rounds = parseInt(evaluationData.dataset.rounds) || 1;
        
        // Rendere Charts nur fÃ¼r Spieler, nicht fÃ¼r Leader
        if (!isLeader) {
            renderContributionChart(contributions);
            renderBalanceChart(balances);
        }
        
        // Animierte Zahlen fÃ¼r Statistiken
        animateStatistics();
        
        // Kooperations-Balken initialisieren
        initCooperationBars();
    });
    
    function renderContributionChart(contributions) {
        const canvas = document.getElementById('contributionChart');
        if (!canvas || !contributions.length) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 40;
        
        // Chart-Hintergrund
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.fillRect(0, 0, width, height);
        
        // Raster zeichnen
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        
        // Horizontale Linien
        for (let i = 0; i <= 5; i++) {
            const y = padding + (i * (height - 2 * padding) / 5);
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
        }
        
        // Daten normalisieren
        const maxContribution = Math.max(...contributions, 1);
        const dataPoints = contributions.map((value, index) => ({
            x: padding + (index / (contributions.length - 1 || 1)) * (width - 2 * padding),
            y: height - padding - (value / maxContribution) * (height - 2 * padding)
        }));
        
        // Linie zeichnen
        ctx.strokeStyle = '#667eea';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        dataPoints.forEach((point, index) => {
            if (index === 0) {
                ctx.moveTo(point.x, point.y);
            } else {
                ctx.lineTo(point.x, point.y);
            }
        });
        ctx.stroke();
        
        // Punkte zeichnen
        ctx.fillStyle = '#667eea';
        dataPoints.forEach(point => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
        
        // Beschriftungen
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        
        // X-Achse (Runden)
        contributions.forEach((_, index) => {
            const x = padding + (index / (contributions.length - 1 || 1)) * (width - 2 * padding);
            ctx.fillText(`R${index + 1}`, x, height - padding + 20);
        });
        
        // Y-Achse (Coins)
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const value = (i / 5) * maxContribution;
            const y = height - padding - (i / 5) * (height - 2 * padding);
            ctx.fillText(value.toFixed(1), padding - 5, y + 3);
        }
        
        // Titel
        ctx.textAlign = 'center';
        ctx.fillText('Einzahlungen pro Runde', width / 2, 20);
    }
    
    function renderBalanceChart(balances) {
        const canvas = document.getElementById('balanceChart');
        if (!canvas || !balances.length) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 40;
        
        // Chart-Hintergrund
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.fillRect(0, 0, width, height);
        
        // Raster zeichnen
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        
        // Horizontale Linien
        for (let i = 0; i <= 5; i++) {
            const y = padding + (i * (height - 2 * padding) / 5);
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
        }
        
        // Daten normalisieren
        const maxBalance = Math.max(...balances);
        const minBalance = Math.min(...balances);
        const range = Math.max(maxBalance - minBalance, 1);
        
        const dataPoints = balances.map((value, index) => ({
            x: padding + (index / (balances.length - 1 || 1)) * (width - 2 * padding),
            y: height - padding - ((value - minBalance) / range) * (height - 2 * padding)
        }));
        
        // Linie zeichnen
        ctx.strokeStyle = '#28a745';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        dataPoints.forEach((point, index) => {
            if (index === 0) {
                ctx.moveTo(point.x, point.y);
            } else {
                ctx.lineTo(point.x, point.y);
            }
        });
        ctx.stroke();
        
        // Punkte zeichnen
        ctx.fillStyle = '#28a745';
        dataPoints.forEach(point => {
            ctx.beginPath();
            ctx.arc(point.x, point.y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
        
        // Beschriftungen
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        
        // X-Achse (Runden)
        balances.forEach((_, index) => {
            const x = padding + (index / (balances.length - 1 || 1)) * (width - 2 * padding);
            ctx.fillText(`R${index + 1}`, x, height - padding + 20);
        });
        
        // Y-Achse (Coins)
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const value = minBalance + (i / 5) * range;
            const y = height - padding - (i / 5) * (height - 2 * padding);
            ctx.fillText(value.toFixed(1), padding - 5, y + 3);
        }
        
        // Titel
        ctx.textAlign = 'center';
        ctx.fillText('Guthabenverlauf', width / 2, 20);
    }
    
    function animateStatistics() {
        // Einfache Animation fÃ¼r die Statistik-Karten
        const statCards = document.querySelectorAll('.stat-card .stat-value');
        statCards.forEach(card => {
            const originalText = card.textContent;
            card.textContent = '0';
            
            let counter = 0;
            const target = parseFloat(originalText.replace(/[^\d.-]/g, ''));
            const increment = target / 50;
            const duration = 1500;
            const stepTime = duration / 50;
            
            const timer = setInterval(() => {
                counter += increment;
                if (counter >= target) {
                    card.textContent = originalText;
                    clearInterval(timer);
                } else {
                    if (originalText.includes('+') || originalText.includes('-')) {
                        const sign = originalText.charAt(0);
                        card.textContent = sign + Math.abs(counter).toFixed(2);
                    } else {
                        card.textContent = counter.toFixed(2);
                    }
                }
            }, stepTime);
        });
    }
    
    function initCooperationBars() {
        // Initialisiere Kooperations-Balken basierend auf data-Attributen
        document.querySelectorAll('.cooperation-bar').forEach(bar => {
            const rate = parseFloat(bar.getAttribute('data-rate'));
            const fill = bar.querySelector('.cooperation-fill');
            if (fill && !isNaN(rate)) {
                fill.style.width = rate + '%';
            }
        });
    }
    
    function exportData() {
        // Einfacher Export (kÃ¶nnte erweitert werden fÃ¼r CSV/PDF)
        const evaluationData = document.querySelector('.evaluation-container').innerHTML;
        const blob = new Blob([evaluationData], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `spielauswertung_raum_{{ room.id }}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification('Auswertung wurde heruntergeladen!', 'success');
    }
</script>
{% endblock %}